// native compilation

#include "../env.docker"

// glibc

cd /src \
    && wget -q "ftp://ftp.gnu.org/gnu/glibc/${GLIBC_VERSION}.tar.gz" \
    && tar xfk ${GLIBC_VERSION}.tar.gz \
    && rm -rf ${GLIBC_VERSION}.tar.gz
[ "$?" != "0" ] && exit 1

pkgname=${GLIBC_VERSION}-chromeos-${CROS_PKG_ARCH}

// specify library directory

#ifdef CHROMEBREW_ARMV7
#define USE_LIB
#endif
#ifdef CHROMEBREW_X86
#define USE_LIB
#endif
#ifdef CHROMEBREW_X64
#define USE_LIB64
#endif

#ifdef USE_LIB
LIB=lib
mkdir -p /build/glibc \
    && cd /build/glibc \
    && LDFLAGS="-Wl,-rpath,${CROS_TARGET_LIB}" /src/${GLIBC_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --target=${CROS_TARGET} \
        ${CROS_NATIVE_LIBC_OPT} \
        --disable-sanity-checks \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install
#endif
#ifdef USE_LIB64
LIB=lib64
// need special treatment to place library files in lib64
mkdir -p /build/glibc \
    && cd /build/glibc \
    && echo "slibdir=${CROS_TARGET_PREFIX}/lib64" > configparms \
    && LDFLAGS="-Wl,-rpath,${CROS_TARGET_LIB}" /src/${GLIBC_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --libdir=${CROS_TARGET_PREFIX}/lib64 \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --target=${CROS_TARGET} \
        ${CROS_NATIVE_LIBC_OPT} \
        --disable-sanity-checks \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install
#endif

[ "$?" != "0" ] && exit 1

// adjust libraries alived already in system

cd ${CROS_HOST_DEST}/${pkgname}

#ifdef CHROMEBREW_ARMV7
rm usr/local/${LIB}/ld-linux-armhf.so.3
ln -s /${LIB}/ld-linux-armhf.so.3 usr/local/${LIB}/ld-linux-armhf.so.3
#endif
#ifdef CHROMEBREW_X86
rm usr/local/${LIB}/ld-linux.so.2
ln -s /${LIB}/ld-linux.so.2 usr/local/${LIB}/ld-linux.so.2
#endif
#ifdef CHROMEBREW_X64
rm usr/local/${LIB}/ld-linux-x86-64.so.2
ln -s /${LIB}/ld-linux-x86-64.so.2 usr/local/${LIB}/ld-linux-x86-64.so.2
#endif

// libc.so and libpthread.so are ld script, so need to maintain symbolic links
rm usr/local/${LIB}/libc-*
rm usr/local/${LIB}/libc.a
rm usr/local/${LIB}/libc.so.6
ln -s /${LIB}/libc.so.6  usr/local/${LIB}/libc.so.6
rm usr/local/${LIB}/libpthread-*.so
rm usr/local/${LIB}/libpthread.a
rm usr/local/${LIB}/libpthread.so.0
ln -s /${LIB}/libpthread.so.0 usr/local/${LIB}/libpthread.so.0

// Remove other libraries already existed in system

// libraries not existed in system although those might be existed previously
#define NO_BROKENLOCALE                 // no libBrokenLocale in system, so leave it as is
#define NO_MEMUSAGE                     // no libmemusage in system, so leave it as is
#define NO_PCPROFILE                    // no libpcprofile in system, so leave it as is
#define NO_SEGFAULT                     // no libSegFault in system, so leave it as is

// remove all libnss* even if some of them are not in system
#if 0
#define NO_NSSCOMPAT                    // no libnss_compat in system, so leave it as is
#define NO_NSSDB                        // no libnss_db in system, so leave it as is
#define NO_NSSHESIOD                    // no libnss_hesiod in system, so leave it as is
#define NO_NSSNISPLUS                   // no libnss_nisplus in system, so leave it as is
#define NO_NSSNIS                       // no libnss_nis in system, so leave it as is
#endif

rm usr/local/${LIB}/libanl[.-]*
#ifndef NO_BROKENLOCALE
rm usr/local/${LIB}/libBrokenLocale[.-]*
#endif
rm usr/local/${LIB}/libcidn[.-]*
rm usr/local/${LIB}/libcrypt[.-]*
rm usr/local/${LIB}/libdl[.-]*
#ifndef NO_MEMUSAGE
rm usr/local/${LIB}/libmemusage[.-]*
#endif
rm usr/local/${LIB}/libm[.-]*
rm usr/local/${LIB}/libnsl[.-]*
#ifndef NO_NSSCOMPAT
rm usr/local/${LIB}/libnss_compat[.-]*
#endif
#ifndef NO_NSSDB
rm usr/local/${LIB}/libnss_db[.-]*
#endif
rm usr/local/${LIB}/libnss_dns[.-]*
rm usr/local/${LIB}/libnss_files[.-]*
#ifndef NO_NSSHESIOD
rm usr/local/${LIB}/libnss_hesiod[.-]*
#endif
#ifndef NO_NSSNISPLUS
rm usr/local/${LIB}/libnss_nisplus[.-]*
#endif
#ifndef NO_NSSNIS
rm usr/local/${LIB}/libnss_nis[.-]*
#endif
#ifndef NO_PCPROFILE
rm usr/local/${LIB}/libpcprofile[.-]*
#endif
rm usr/local/${LIB}/libresolv[.-]*
rm usr/local/${LIB}/librt[.-]*
#ifndef NO_SEGFAULT
rm usr/local/${LIB}/libSegFault[.-]*
#endif
rm usr/local/${LIB}/libthread_db[.-]*
rm usr/local/${LIB}/libutil[.-]*

cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
