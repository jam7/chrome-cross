// native compilation

#include "../env.docker"

// prepare gcc and library sources

// Following sed command at *1* is to fix undefined '__stack_chk_guard' problem on x86 and x64.
// see http://www.linuxquestions.org/questions/linux-from-scratch-13/install-glibc-2-17-error-help-me-4175460557/ and
// http://stackoverflow.com/questions/15787684/lfs-glibc-compilation-ld-error for mode details

// Following sed command at *2* is to fix link error of isl_polyhedron_sample.
// This is required under cross-compiling environment unfortunately

cd /src \
    && wget -q "ftp://ftp.gnu.org/gnu/gmp/${GMP_VERSION}.tar.bz2" \
    && wget -q "ftp://ftp.gnu.org/gnu/mpfr/${MPFR_VERSION}.tar.gz" \
    && wget -q "ftp://ftp.gnu.org/gnu/mpc/${MPC_VERSION}.tar.gz" \
    && wget -q "http://isl.gforge.inria.fr/${ISL_VERSION}.tar.xz" \
    && wget -q "http://www.bastoul.net/cloog/pages/download/count.php3?url=./${CLOOG_VERSION}.tar.gz" -O "${CLOOG_VERSION}.tar.gz" \
    && wget -q "ftp://gcc.gnu.org/pub/gcc/releases/${GCC_VERSION}/${GCC_VERSION}.tar.bz2" \
    && for f in *.tar*; do tar xfk $f; done \
    && rm -rf *.tar* \
    && sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' /src/${GCC_VERSION}/gcc/configure /*1*/ \
    && sed -i /src/${ISL_VERSION}/Makefile.in -e '/^isl_polyhedron_sample_LDADD/s/$/ @MP_LIBS@/' \
         -e '/^isl_polyhedron_detect_equalities_LDADD/s/$/ @MP_LIBS@/' \
         -e '/^isl_polytope_scan_LDADD/s/$/ @MP_LIBS@/' \
         -e '/^isl_closure_LDADD/s/$/ @MP_LIBS@/' \
         -e '/^isl_cat_LDADD/s/$/ @MP_LIBS@/' \
         /*2*/
[ "$?" != "0" ] && exit 1

// gmp

pkgname=${GMP_VERSION}-chromeos-${CROS_PKG_ARCH}
mkdir -p /build/gmp \
    && cd /build/gmp \
    && LDFLAGS=${CROS_NATIVE_LDFLAGS} /src/${GMP_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --libdir=${CROS_TARGET_LIB} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --enable-cxx \
        --disable-static \
        --with-sysroot=${CROS_HOST_PREFIX}/${CROS_TARGET} \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_PREFIX}/${CROS_TARGET} install-strip \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install-strip \
    && cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
[ "$?" != "0" ] && exit 1

// mpfr

pkgname=${MPFR_VERSION}-chromeos-${CROS_PKG_ARCH}
mkdir -p /build/mpfr \
    && cd /build/mpfr \
    && LDFLAGS=${CROS_NATIVE_LDFLAGS} /src/${MPFR_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --libdir=${CROS_TARGET_LIB} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --disable-static \
        --with-sysroot=${CROS_HOST_PREFIX}/${CROS_TARGET} \
        --with-gmp-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-gmp-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_PREFIX}/${CROS_TARGET} install-strip \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install-strip \
    && cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
[ "$?" != "0" ] && exit 1

// mpc

pkgname=${MPC_VERSION}-chromeos-${CROS_PKG_ARCH}
mkdir -p /build/mpc \
    && cd /build/mpc \
    && LDFLAGS=${CROS_NATIVE_LDFLAGS} /src/${MPC_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --libdir=${CROS_TARGET_LIB} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --disable-static \
        --with-sysroot=${CROS_HOST_PREFIX}/${CROS_TARGET} \
        --with-gmp-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-gmp-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
        --with-mpfr-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-mpfr-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_PREFIX}/${CROS_TARGET} install-strip \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install-strip \
    && cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
[ "$?" != "0" ] && exit 1

// isl

pkgname=${ISL_VERSION}-chromeos-${CROS_PKG_ARCH}
mkdir -p /build/isl \
    && cd /build/isl \
    && LDFLAGS=${CROS_NATIVE_LDFLAGS} /src/${ISL_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --libdir=${CROS_TARGET_LIB} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --disable-static \
        --with-sysroot=${CROS_HOST_PREFIX}/${CROS_TARGET} \
        --with-gmp-prefix=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX} \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_PREFIX}/${CROS_TARGET} install-strip \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install-strip \
    && cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
[ "$?" != "0" ] && exit 1

// cloog

// cloog needs to have libisl.so.XX at /lib unfortunately
ln -s "${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB}/"libisl.so.* \
    "${CROS_HOST_PREFIX}/${CROS_TARGET}/lib"

pkgname=${CLOOG_VERSION}-chromeos-${CROS_PKG_ARCH}
mkdir -p /build/cloog \
    && cd /build/cloog \
    && LDFLAGS=${CROS_NATIVE_LDFLAGS} /src/${CLOOG_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --libdir=${CROS_TARGET_LIB} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --disable-static \
        --with-sysroot=${CROS_HOST_PREFIX}/${CROS_TARGET} \
        --with-gmp-prefix=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX} \
        --with-isl-prefix=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX} \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_PREFIX}/${CROS_TARGET} install-strip \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install-strip \
    && cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
[ "$?" != "0" ] && exit 1

// gcc

pkgname=${GCC_VERSION}-chromeos-${CROS_PKG_ARCH}
mkdir -p /build/gcc \
    && cd /build/gcc \
    && LDFLAGS=${CROS_NATIVE_LDFLAGS} /src/${GCC_VERSION}/configure \
        --prefix=${CROS_TARGET_PREFIX} \
        --build=${CROS_HOST} \
        --host=${CROS_TARGET} \
        --target=${CROS_TARGET} \
        --enable-languages=c,c++,fortran \
        --disable-static \
        --disable-werror \
        --with-gmp-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-gmp-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
        --with-mpfr-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-mpfr-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
        --with-mpc-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-mpc-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
        --with-isl-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-isl-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
        --with-cloog-include=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_PREFIX}/include \
        --with-cloog-lib=${CROS_HOST_PREFIX}/${CROS_TARGET}${CROS_TARGET_LIB} \
        ${CROS_NATIVE_GCC_OPT} \
    && make -j ${CROS_CORES} \
    && make DESTDIR=${CROS_HOST_DEST}/${pkgname} install-strip \
    && find ${CROS_HOST_DEST}/${pkgname}${CROS_TARGET_LIB} -maxdepth 1 -name '*.a' | grep -v nonshared.a | xargs rm \
    && cd ${CROS_HOST_DEST}/${pkgname} \
    && sh ../create_package.sh \
    && rm -rf ${CROS_HOST_DEST}/${pkgname}
